{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="medicine-container">
    <h2>Create New Medicine</h2>

    <form id="medicine-form" class="medicine-form">
        {% csrf_token %}

        <!-- Basic Information -->
        <div class="form-row">
            <input type="text" id="name" placeholder="Medicine Name*" required>
            <input type="number" step="0.01" id="price" placeholder="Price*" required>
        </div>

        <!-- Stock and Measurements -->
        <div class="form-row">
            <input type="number" id="stock_quantity" placeholder="Stock Quantity*" required>
            <input type="text" id="weight_or_count" placeholder="Weight/Count (e.g., 50ml)*" required>
        </div>

        <!-- Description -->
        <textarea id="description" placeholder="Description"></textarea>
        <input type="text" id="dosage" placeholder="Dosage Instructions (e.g., 2 drops/day)">

        <!-- Dates and Prescription -->
        <div class="form-row">
            <input type="date" id="expiration_date" placeholder="Expiration Date">
            <div class="checkbox-container">
                <input type="checkbox" id="requires_prescription">
                <label for="requires_prescription">Requires Prescription</label>
            </div>
        </div>

        <!-- Category and Manufacturer -->
        <div class="form-row">
            <input type="text" id="category" placeholder="Category IDs (comma separated)">
            <input type="number" id="manufacturer" placeholder="Manufacturer ID">
        </div>

        <button type="submit">Create Medicine</button>
    </form>

    <div id="response-message"></div>
</div>

<style>
    .medicine-container {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 600px;
        margin: 2rem auto;
    }
    h2 {
        text-align: center;
        margin-bottom: 1.5rem;
        color: #333;
    }
    .medicine-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .form-row {
        display: flex;
        gap: 1rem;
    }
    input, textarea, select {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        width: 100%;
    }
    textarea {
        min-height: 100px;
        resize: vertical;
    }
    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        width: 100%;
    }
    .checkbox-container input {
        width: auto;
    }
    button {
        background-color: #28a745;
        color: white;
        padding: 0.75rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 1rem;
        transition: background-color 0.3s;
    }
    button:hover {
        background-color: #218838;
    }
    #response-message {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }
    .success {
        background-color: #d4edda;
        color: #155724;
    }
    .error {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('medicine-form');
    const responseDiv = document.getElementById('response-message');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        responseDiv.innerHTML = '';
        responseDiv.className = 'response-message';

        // Get JWT token
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const token = getCookie('access') || localStorage.getItem('access_token');

        if (!token) {
            window.location.href = '{% url "users:login-api" %}';
            return;
        }

        // Prepare form data with all fields
        const formData = {
            name: document.getElementById('name').value,
            price: parseFloat(document.getElementById('price').value),
            stock_quantity: parseInt(document.getElementById('stock_quantity').value),
            description: document.getElementById('description').value,
            dosage: document.getElementById('dosage').value,
            requires_prescription: document.getElementById('requires_prescription').checked,
            weight_or_count: document.getElementById('weight_or_count').value,
            expiration_date: document.getElementById('expiration_date').value,
            category: document.getElementById('category').value
                ? document.getElementById('category').value.split(',').map(Number).filter(id => !isNaN(id))
                : [],
            manufacturer: document.getElementById('manufacturer').value
                ? parseInt(document.getElementById('manufacturer').value)
                : null
        };

        try {
            const response = await fetch('{% url "medicine:medicine-api-create" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                responseDiv.textContent = 'Medicine created successfully!';
                responseDiv.classList.add('success');
                form.reset();

                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = '{% url "medicine:medicine-api-list" %}';
                }, 2000);
            } else {
                let errorMessage = result.detail || 'Failed to create medicine';
                if (result.errors) {
                    errorMessage = Object.entries(result.errors)
                        .map(([field, errors]) => `${field}: ${errors.join(', ')}`)
                        .join('\n');
                }
                responseDiv.textContent = errorMessage;
                responseDiv.classList.add('error');
            }
        } catch (error) {
            responseDiv.textContent = 'Network error. Please try again.';
            responseDiv.classList.add('error');
            console.error('Error:', error);
        }
    });

    // Set minimum date to today for expiration date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expiration_date').min = today;
});
</script>
{% endblock %}